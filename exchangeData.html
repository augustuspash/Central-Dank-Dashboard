<!--* Copyright (C) 2016 Augustus York Rushton Pash - All Rights Reserved
 * You may use, distribute and modify this code under the
 * terms of the license, which was distrubted with this code and located
 * at: https://github.com/augustuspash/CentralDankDashboard
 *
 * You should have received a copy of the license with
 * this file. If not, please visit: https://github.com/augustuspash/CentralDankDashboard
 -->


<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, shrink-to-fit=no, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Dashboard</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/simple-sidebar.css" rel="stylesheet">
    <style>
        .table>tbody>tr.active>td, .table>tbody>tr.active>th, .table>tbody>tr>td.active, .table>tbody>tr>th.active, .table>tfoot>tr.active>td, .table>tfoot>tr.active>th, .table>tfoot>tr>td.active, .table>tfoot>tr>th.active, .table>thead>tr.active>td, .table>thead>tr.active>th, .table>thead>tr>td.active, .table>thead>tr>th.active {
            background-color:#5c5c5c;
        }
    </style>
    
    <!--Datatables -->
    <link rel="stylesheet" type="text/css" href="DataTables/datatables.min.css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <div id="wrapper">

        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="index.html">
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="index.html">Home</a>
                </li>
                <li>
                    <a href="portfolio.html">Portfolio</a>
                </li>
                <li>
                    <a href="exchange.html">Exchange</a>
                </li>
                <li class="sidebar-brand">
                    <a href="#">
                        Contracts
                    </a>
                </li>
                <li>
                    <a href="dmx.html">Dank Meme Exchange</a>
                </li>
                <li>
                    <a href="dank.html">Dankness</a>
                </li>
                <li>
                    <a href="meme.html">Memes</a>
                </li>
                <li>
                    <a href="faucet.html">Faucet</a>
                </li>
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->
        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="well" style="width:100%;"><span>Account: <span id="account"></span></span><span style="float:right;">Dankness: <span id="dankness"></span></span></div>
                        <div class="well" style="width:100%">
                            <h1>Exchange: <span id="id"></span></h1>
                        </div>
                        <div class="well">
                            <button id="buyMeme" type="button" class="btn btn-default pull-right inline">Buy Shares</button>
                                <button id="refresh" type="button" class="btn btn-default pull-right inline" onclick="location.reload();">Refresh</button>
                                <button id="urlButton" type="button" class="btn btn-default pull-right inline">Open Url</button>
                                <button id="testUrl" type="button" class="btn btn-default pull-right inline">Test Url</button>
                            <div class="" style="height:30px;">
                                Average Buy/Exchange Ask:&nbsp;<span id="directPrice"></span>,
                                Average Ask:&nbsp;<span id="avgPrice"></span>
                            </div>
                        </div>
                        <table id="memes" class="table table-striped table-bordered" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Person</th>
                                    <th>Price</th>
                                    <th>Amount</th>
                                    <th>Price Per Share</th>
                                </tr>
                            </thead>
                            <tfoot>
                                <tr>
                                    <th>Key</th>
                                    <th>Person</th>
                                    <th>Price</th>
                                    <th>Amount</th>
                                    <th>Price Per Share</th>
                                </tr>
                            </tfoot>
                            <tbody>
                            </tbody>
                        </table>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="well" style="width:100%">
                                    <h4>List Shares</h4>
                                </div>
                                <div class="well">
                                        <div class="form-group">
                                            <label>Amount of Shares:</label>
                                            <input class="form-control" type="number" id="shareAmount" min="1" step="1" />
                                        </div>
                                        <div class="form-group">
                                            <label>Price:</label>
                                            <input class="form-control"type="number" id="sharePrice" min="1" step="1" />
                                        </div>
                                        <div class="form-group">
                                            <label>Listing Key (unique key used to identify the listing):</label>
                                            <input class="form-control" id="listingKey" type="text" />
                                        </div>
                                        <button id="list" type="button" class="btn btn-default">List</button>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="well" style="width:100%">
                                    <h4>Remove Listing</h4>
                                </div>
                                <div class="well">
                                        <div class="form-group">
                                            <label>Listing Key (unique key used to identify the listing):</label>
                                            <input class="form-control" id="removeKey" type="text" />
                                        </div>
                                        <button id="remove" type="button" class="btn btn-default">Remove</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /#page-content-wrapper -->

    </div>
    <!-- /#wrapper -->
    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>
    
    <!--Datatables -->
    <script type="text/javascript" src="DataTables/datatables.min.js"></script>
    
    <!-- Web3 JavaScript -->
    <script src="js/web3.min.js"></script>
    <script src="contracts/dankness.js"></script>
    <script src="contracts/memes.js"></script>
    <script src="contracts/dmx.js"></script>
    
    <!-- Store JavaScript -->
    <script src="js/store.min.js"></script>

    <!-- Scripts -->
    <script>
        function getSearchParameters() {
            var prmstr = window.location.search.substr(1);
            return prmstr != null && prmstr != "" ? transformToAssocArray(prmstr) : {};
        }

        function transformToAssocArray( prmstr ) {
            var params = {};
            var prmarr = prmstr.split("&");
            for ( var i = 0; i < prmarr.length; i++) {
                var tmparr = prmarr[i].split("=");
                params[tmparr[0]] = decodeURI(tmparr[1]);
            }
            return params;
        }

        var params = getSearchParameters();
        var averagePrice = 0.0000000000;
        var dataTable;
        var selected = "";
        window.addEventListener('load', function () {
            if (typeof web3 !== 'undefined') {
                web3 = new Web3(web3.currentProvider);
            } else {
                console.log('No web3? You should consider trying MetaMask!')
                web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
            }

            loadDankness();
            loadMemes();
            loadDMX();
            
            $("#id").text(params.i);
            
            loadListings();

            var account = web3.eth.accounts[0];
            $("#account").text(account);
            var accountInterval = setInterval(function () {
                if (web3.eth.accounts[0] !== account) {
                    account = web3.eth.accounts[0];
                    $("#account").text(account);
                }
            }, 100);
            
            var balanceInterval = setInterval(function () {
                Dankness.balanceOf.call(web3.eth.accounts[0], function (error, result) {
                    if (!error) {
                        $("#dankness").text(insertDecimal(result));
                    } else {
                        $("#dankness").text("error");
                    }
                });
            }, 500);
            
            var priceInterval = setInterval(function () {
                if (params.i == undefined) {
                    $("#directPrice").text("0.0000000000");
                }
                DMX.getDirectPrice.call(params.i, function (error, result) {
                    if (!error) {
                        $("#directPrice").text(insertDecimal(result.toNumber()));
                    } else {
                        $("#directPrice").text("0.0000000000");
                    }
                });
            }, 500);
            
            var avgPriceInterval = setInterval(function () {
                 $("#avgPrice").text(averagePrice.toFixed(10));
            }, 100);

            $("#menu-toggle").click(function (e) {
                e.preventDefault();
                $("#wrapper").toggleClass("toggled");
            });
            
            dataTable = $('#memes').DataTable();
        });
        
        $(document).ready(function() {
             $('#memes tbody').on( 'click', 'tr', function () {
                if ( $(this).hasClass('active') ) {
                    $(this).removeClass('active');
                    $("#identifier").text("");
                    selected = "";
                }
                else {
                    dataTable.$('tr.active').removeClass('active');
                    $(this).addClass('active');
                    $("#identifier").text(dataTable.row('.active').data());
                    selected = dataTable.row('.active').data()[0];
                }
            });
            
            $("#list").click(function() {
                $('#list').prop('disabled', true);
                if (params.i != undefined) {
                    Memes.sharesOf.call(params.i, web3.eth.accounts[0], function(error, results) {
                        var ownedShares = results.toNumber();
                        var shares = Number($("#shareAmount").val());
                        if (shares <= ownedShares) {
                            Memes.allowance(params.i, web3.eth.accounts[0], DMXAddress, function(error, results) {
                                var allowance = results.toNumber();
                                if (allowance + shares <= ownedShares){
                                    Memes.approve(params.i, DMXAddress, shares + allowance, function(error, results) {
                                        if (!error) {
                                            DMX.placeListing(params.i, balanceToInt(Number($("#sharePrice").val())), shares, $("#listingKey").val(), function() {
                                                $('#list').prop('disabled', false);
                                            });
                                        } else {
                                            $('#list').prop('disabled', false);
                                        }
                                    });
                                } else {
                                    DMX.placeListing(params.i, balanceToInt(Number($("#sharePrice").val())), shares, $("#listingKey").val(), function() {
                                        $('#list').prop('disabled', false);
                                    });
                                }
                            });
                        }
                    });
                }
            });
            
            $("#buyMeme").click(function () {
                if (selected != "") {
                    $('#buyMeme').prop('disabled', true);
                    var listing = dataTable.row('.active').data();
                    listing[2] = balanceToInt(Number(listing[2]));
                    Dankness.balanceOf.call(web3.eth.accounts[0], function (error, result) {
                        var balance = result.toNumber();
                        if (balance >= listing[2]) {
                            Dankness.allowance.call(web3.eth.accounts[0], DMXAddress, function(error, result) {
                                var allowance = result.toNumber();
                                if (allowance + listing[2] <= balance) {
                                    Dankness.approve(DMXAddress, allowance + listing[2], function(error, result) {
                                        DMX.buy(params.i, listing[1], listing[2], listing[3], listing[0], function (error, result) {
                                            $('#buyMeme').prop('disabled', false);   
                                        });
                                    });
                                } else {
                                    DMX.buy(params.i, listing[1], listing[2], listing[3], listing[0], function (error, result) {
                                        $('#buyMeme').prop('disabled', false);   
                                    });
                                }
                            });
                        }
                    });
                }
            });
            
            $("#urlButton").on("click", function () {
                if (params.i != undefined) {
                    Memes.memeUrl.call(params.i, function(error, results){
                        if (confirm('Are you sure you wish to open this link? We can not vouch for the content of the website this url is linking to. By clicking ok you agree that we are not liable for anything that happens as a result of opening that link.')) {
                            var hiddenElement = document.createElement('a');
                            hiddenElement.href = results;
                            hiddenElement.click();
                        }   
                    });
                }
            });
            
            $("#testUrl").on("click", function() {
                 if (params.i != undefined) {
                    Memes.memeUrl.call(params.i, function(error, url){
                        timeout = 5000;
                        var timedOut = false, timer;
                        var img = new Image();
                        img.onerror = img.onabort = function() {
                            if (!timedOut) {
                                clearTimeout(timer);
                                alert("Url does not seem to point to an image.");
                            }
                        };
                        img.onload = function() {
                            if (!timedOut) {
                                clearTimeout(timer);
                                alert("Url seems to point to an image.");
                            }
                        };
                        img.src = url;
                        timer = setTimeout(function() {
                            timedOut = true;
                            alert("Url check timed out.");
                        }, timeout); 
                    });
                 } else {
                    alert("No url.");
                    return;
                }
            });
            
            $("#remove").click(function() {
                $('#remove').prop('disabled', true);
                if (params.i != undefined) {
                    var key = $("#removeKey").val();
                    DMX.getListing["string,address,string"].call(params.i, web3.eth.accounts[0], key, function(error,result) {
                        DMX.endListing(params.i, result[2].toNumber(), result[3].toNumber(), key, function(error,result) {
                            $('#remove').prop('disabled', false);
                        });
                    });
                }
            })
        } );
        
        function loadListings() {
            if (params.i == "" || params == undefined) {
                return;
            }
            DMX.listingLength.call(params.i, function(error, results) {
                var length = results.toNumber();
                loadListingsRecursiveLoop(0, length);
            });
        }   
        
        function loadListingsRecursiveLoop(i, length) {
            if (i >= length) {
                return;
            }
            setTimeout(function() {
                loadListingsRecursiveLoop(i+1,length);
                DMX.getListing["string,uint256"].call(params.i, i, function(error, results) {
                        results[2] = insertDecimal(Number(results[2]));
                        results[3] = Number(results[3]);
                        
                        results[4] = (results[2] / results[3]).toFixed(10);
                        
                        averagePrice = averagePrice*(1/((i+1)/i)) + results[4] / (i+1);
                        
                        dataTable.row.add(results).draw( false );
                    });
            }, 300);
        }
    </script>

</body>

</html>
