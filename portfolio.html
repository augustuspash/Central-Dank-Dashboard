<!--* Copyright (C) 2016 Augustus York Rushton Pash - All Rights Reserved
 * You may use, distribute and modify this code under the
 * terms of the license, which was distrubted with this code and located
 * at: https://github.com/augustuspash/CentralDankDashboard
 *
 * You should have received a copy of the license with
 * this file. If not, please visit: https://github.com/augustuspash/CentralDankDashboard
 -->


<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, shrink-to-fit=no, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Dashboard</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/simple-sidebar.css" rel="stylesheet">
    <style>
        .table>tbody>tr.active>td, .table>tbody>tr.active>th, .table>tbody>tr>td.active, .table>tbody>tr>th.active, .table>tfoot>tr.active>td, .table>tfoot>tr.active>th, .table>tfoot>tr>td.active, .table>tfoot>tr>th.active, .table>thead>tr.active>td, .table>thead>tr.active>th, .table>thead>tr>td.active, .table>thead>tr>th.active {
            background-color:#5c5c5c;
        }
    </style>
    
    <!--Datatables -->
    <link rel="stylesheet" type="text/css" href="DataTables/datatables.min.css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <div id="wrapper">

        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="index.html">
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="index.html">Home</a>
                </li>
                <li>
                    <a href="portfolio.html">Portfolio</a>
                </li>
                <li class="sidebar-brand">
                    <a href="#">
                        Contracts
                    </a>
                </li>
                <li>
                    <a href="dmx.html">Dank Meme Exchange</a>
                </li>
                <li>
                    <a href="dank.html">Dankness</a>
                </li>
                <li>
                    <a href="meme.html">Memes</a>
                </li>
                <li>
                    <a href="faucet.html">Faucet</a>
                </li>
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->
        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="well" style="width:100%;"><span>Account: <span id="account"></span></span><span style="float:right;">Dankness: <span id="dankness"></span></span></div>
                        <div class="well" style="width:100%">
                            <button id="backup" type="button" class="btn btn-default pull-right inline">Backup Porfolio</button>
                             <button id="loadRecords" type="button" class="btn btn-default pull-right inline">Load From Records</button>
                            <button id="loadBackup" type="button" class="btn btn-default pull-right inline">Load Backup</button>
                            <h1>Portfolio</h1>
                        </div>
                        <div class="well">
                                <button id="remove" type="button" class="btn btn-default pull-right inline">Remove</button>
                                <div class="inline pull-right" style="width:200px;">
                                    <div class="input-group inline pull-left">
                                        <input id="idAdd" type="text" class="form-control" placeholder="Identifier">
                                        <span class="input-group-btn">
                                            <button id="add" class="btn btn-default" type="button">Add Meme</button>
                                        </span>
                                    </div>
                                </div>
                                <button id="openExchange" type="button" class="btn btn-default inline">Open in Exchange</button>
                                <button id="testUrl" type="button" class="btn btn-default pull-left inline">Test Url</button>
                                <button id="urlButton" type="button" class="btn btn-default pull-left inline">Open Url</button>
                        </div>
                        <div class="row" >
                            <div class="col-lg-6">
                                <div class="well">
                                    <div><label>Identifier:&nbsp;</label><span id="identifier"></span></div>
                                    <div><label>Indexed:&nbsp;</label><span id="indexed"></span></div>
                                    <div><label>Url:&nbsp;</label><span id="url"></span></div>
                                    <div><label>Total Shares:&nbsp;</label><span id="tShares"></span></div>
                                    <div><label>Owned Shares:&nbsp;</label><span id="oShares"></span></div>
                                    <div><label>Exchange Price:&nbsp;</label><span id="exPrice"></span></div>
                                </div>
                                <div class="well" style="width:100%">
                                    <h4>Transfer Shares</h4>
                                </div>
                                <div class="well">
                                    <div class="form-group">
                                        <label>Meme:</label>
                                        <input class="form-control" id="transferMeme" type="text" />
                                    </div>
                                    <div class="form-group">
                                        <label>Amount:</label>
                                        <input class="form-control" type="number" id="transferAmount" min="0" step="1" />
                                    </div>
                                    <div class="form-group">
                                        <label>To Address:</label>
                                        <input class="form-control" id="transferAddress" type="text" />
                                    </div>
                                    <button id="transfer" type="button" class="btn btn-default">Transfer</button>
                                </div>
                                <div class="well" style="width:100%">
                                    <h4>Index Meme</h4>
                                </div>
                                <div class="well">
                                    <div class="form-group">
                                        <label>Meme:</label>
                                        <input class="form-control" id="indexMemeMeme" type="text" />
                                    </div>
                                    <div class="form-group">
                                        <label>Url:</label>
                                        <input class="form-control" id="indexMemeUrl" type="text" />
                                    </div>  
                                    <button id="indexMeme" type="button" class="btn btn-default">Index</button>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <table id="memes" class="table table-striped table-bordered" cellspacing="0" width="100%">
                                    <thead>
                                        <tr>
                                            <th>Identifier</th>
                                        </tr>
                                    </thead>
                                    <tfoot>
                                        <tr>
                                            <th>Identifier</th>
                                        </tr>
                                    </tfoot>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-lg-6">
                                
                            </div>
                            <div class="col-lg-6">
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /#page-content-wrapper -->

    </div>
    <!-- /#wrapper -->
    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>
    
    <!--Datatables -->
    <script type="text/javascript" src="DataTables/datatables.min.js"></script>
    
    <!-- Web3 JavaScript -->
    <script src="js/web3.min.js"></script>
    <script src="contracts/dankness.js"></script>
    <script src="contracts/memes.js"></script>
    
    <!-- Store JavaScript -->
    <script src="js/store.min.js"></script>

    <!-- Scripts -->
    <script>
        var dataTable;
        window.addEventListener('load', function () {
            if (!store.enabled) {
                alert('Local storage is not supported by your browser. Please disable "Private Mode", or upgrade to a modern browser.')
                return;
            }
            
            loadPortfolioData();
            
            if (typeof web3 !== 'undefined') {
                web3 = new Web3(web3.currentProvider);
            } else {
                console.log('No web3? You should consider trying MetaMask!')
                web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
            }

            loadDankness();
            loadMemes();

            var account = web3.eth.accounts[0];
            $("#account").text(account);
            var accountInterval = setInterval(function () {
                if (web3.eth.accounts[0] !== account) {
                    account = web3.eth.accounts[0];
                    $("#account").text(account);
                }
            }, 500);
            
            var memeDataInterval = setInterval(function () {
                 Memes.sharesOf.call(id, web3.eth.accounts[0], function (error, results) {
                        $("#oShares").text(results.toNumber());
                 });
            }, 500);

            var balanceInterval = setInterval(function () {
                Dankness.balanceOf.call(web3.eth.accounts[0], function (error, result) {
                    if (!error) {
                        $("#dankness").text(insertDecimal(result));
                    } else {
                        $("#dankness").text("error");
                    }
                });
            }, 500);

            $("#menu-toggle").click(function (e) {
                e.preventDefault();
                $("#wrapper").toggleClass("toggled");
            });
            
            
        });
        
        $(document).ready(function() {
            $('#memes tbody').on( 'click', 'tr', function () {
                if ( $(this).hasClass('active') ) {
                    $(this).removeClass('active');
                    $("#identifier").text("");
                    unloadMemeData();
                }
                else {
                    dataTable.$('tr.active').removeClass('active');
                    $(this).addClass('active');
                    $("#identifier").text(dataTable.row('.active').data());
                    loadMemeData(dataTable.row('.active').data()[0]);
                }
            });
            
            $("#add").on( 'click', function () {
                var text = $("#idAdd").val();
                if (text != "") {
                    addMeme(text);
                }
            });
            
            $("#remove").on( 'click', function () {
                var id = dataTable.row('.active').data()[0];
                if (id != "") {
                    removeMeme(id);
                    dataTable.row('.active').remove().draw(false);
                }
            });
            
            $("#urlButton").on("click", function () {
                if ($("#url").text() != "" && confirm('Are you sure you wish to open this link? We can not vouch for the content of the website this url is linking to. By clicking ok you agree that we are not liable for anything that happens as a result of opening that link.')) {
                    window.open($("#url").text());
                }
            });
            
            $("#testUrl").on("click", function() {
                url = $("#url").text();
                if (url == "") {
                    alert("No url.");
                    return;
                }
                timeout = 5000;
                var timedOut = false, timer;
                var img = new Image();
                img.onerror = img.onabort = function() {
                    if (!timedOut) {
                        clearTimeout(timer);
                        alert("Url does not seem to point to an image.");
                    }
                };
                img.onload = function() {
                    if (!timedOut) {
                        clearTimeout(timer);
                        alert("Url seems to point to an image.");
                    }
                };
                img.src = url;
                timer = setTimeout(function() {
                    timedOut = true;
                    alert("Url check timed out.");
                }, timeout); 
            });
            
            $("#openExchange").on("click", function() {
                alert("coming soon");
            });
            
            $("#indexMeme").click(function (e) {
                $('#indexMeme').prop('disabled', true);
                Memes.indexingCost.call(function (error, result) {
                    console.log(result.toNumber());
                    if (error) {
                        $('#indexMeme').prop('disabled', false);
                        return;
                    } else {
                        console.log(result.toNumber());
                        Memes.indexMeme.sendTransaction($("#indexMemeMeme").val(), $("#indexMemeUrl").val(), { from: web3.eth.accounts[0], value: result.toNumber()}, function (error, results) {
                            $('#indexMeme').prop('disabled', false);
                        });
                    }
                });
            });
            
            $("#transfer").click(function (e) {
                $('#transfer').prop('disabled', true);
                Memes.transfer($("#transferMeme").val(), $("#transferAddress").val(), Number($("#transferAmount").val()), { from: web3.eth.accounts[0] }, function (error, results) {
                    $('#transfer').prop('disabled', false);
                });
            });
            
            $("#backup").click(function() {
                var textToSave = JSON.stringify(store.get('portfolio'));

                var hiddenElement = document.createElement('a');

                hiddenElement.href = 'data:attachment/text,' + encodeURI(textToSave);
                hiddenElement.target = '_blank';
                hiddenElement.download = 'backup.json';
                hiddenElement.click();
            });
            
            $("#loadBackup").click(function() {
                var data = JSON.parse(prompt("Please paste in the backed up data."));
                if (data.length == undefined || data.length == 0) {
                    alert("Failed");
                } else {
                    for (var i = 0; i < data.length; i++) {
                        if (data[i].length != 1 && typeof data[i] !== 'string') {
                            alert("Failed");
                            return;
                        }
                    }
                    store.set('portfolio', data);
                    location.reload();
                }
            });
            
            $("#loadRecords").click(function () {
                MemeRecord.recordLength.call(web3.eth.accounts[0], function (error, result) {
                    var length = result.toNumber();
                    for (var i = 0; i < length; i++) {
                        MemeRecord.getRecord.call(web3.eth.accounts[0], i, function (error, result) {
                            if (typeof result == 'string') {
                                addMeme(result);
                            }
                        });
                    }
                });
            });
        } );
        
        function addMeme(id) {
            var dataset = store.get('portfolio');
            if (dataset == undefined) {
                dataset = [[id]];
            } else {
                for (var i = 0; i < dataset.length; i++) {
                    if (dataset[i][0] == id) {
                        return;
                    }
                }
                dataset[dataset.length] = [id];
            }
            store.set('portfolio', dataset);
            dataTable.row.add([id]).draw( false );
        }
        
        function removeMeme(id) {
            var dataset = store.get('portfolio');
            for (var i = 0; i < dataset.length; i++) {
                if (dataset[i][0] == id) {
                    dataset[i] = dataset[dataset.length - 1];
                    dataset.length--;
                }
            }
            store.set('portfolio', dataset);
            
        }
        
        function loadMemeData(id) {
            Memes.isCreated.call(id, function (error, results) {
                $("#indexed").text(results);
                if (results) {
                    Memes.sharesOf.call(id, web3.eth.accounts[0], function (error, results) {
                        $("#oShares").text(results.toNumber());
                    });
                    Memes.maxSharesOf.call(id, function (error, results) {
                        $("#tShares").text(results.toNumber());
                    });
                    Memes.memeUrl.call(id, function (error, results) {
                        $("#url").text(results);
                    });
                } else {
                    unloadMemeData();
                }
            });
        }
        
        function unloadMemeData() {
            $("#tShares").text("");
            $("#url").text("");
            $("#indexed").text("");
            $("#oShares").text("");
        }
        
        function loadPortfolioData() {
            var dataset = store.get('portfolio');
            if (dataset == undefined){
                dataTable = $('#memes').DataTable();
            } else {
                dataTable = $('#memes').DataTable( {
                    data: dataset,
                    columns: [
                        { title: "Identifier" }
                    ]
                } );
            }
        }
    </script>

</body>

</html>
